services:
  spectrum:
    build:
      context: spectrum
    tty: true
    stdin_open: true
    environment:
      UID: "0"
      GID: "0"
      MEMORY: "8G"
      EULA: "TRUE"
      DIFFICULTY: "easy"
      SNOOPER_ENABLED: "false"
      SPAWN_PROTECTION: "16"
      VIEW_DISTANCE: "12"
      MODE: "survival"
      SERVER_PORT: "25566"
      SEED: "-2751134287749678599"
      CFG_PROXY_SECRET: "secret"
      CFG_LUCKPERMS_DB_HOST: "luckperms-db"
      CFG_LUCKPERMS_DB_PORT: "5432"
      CFG_LUCKPERMS_DB_NAME: "luckperms"
      CFG_LUCKPERMS_DB_USERNAME: "luckperms"
      CFG_LUCKPERMS_DB_PASSWORD: "luckperms"
      CFG_POLYMER_RESOURCE_PACK_PATH: "/self-host-rps/polymer.zip"
    links:
      - luckperms-db
    volumes:
      - self-host-rps:/self-host-rps

  proxy:
    build:
      context: proxy
    tty: true
    stdin_open: true
    environment:
      UID: "0"
      GID: "0"
      MEMORY: "4G"
      CFG_SERVER_TRY_1: "survival"
      CFG_SERVER_TRY_2: "fallback"
      CFG_BIND_HOST: "0.0.0.0"
      CFG_BIND_PORT: "25565"
      CFG_MOTD: "Proxy server"
      CFG_SHOW_MAX_PLAYERS: "12"
      CFG_SERVER_SURVIVAL_HOST: "spectrum"
      CFG_SERVER_SURVIVAL_PORT: "25566"
      CFG_SERVER_FALLBACK_HOST: "fallback"
      CFG_SERVER_FALLBACK_PORT: "25567"
      CFG_FORWARDING_SECRET_FILE: "/proxy-secret"
      CFG_LUCKPERMS_DB_HOST: "luckperms-db"
      CFG_LUCKPERMS_DB_PORT: "5432"
      CFG_LUCKPERMS_DB_NAME: "luckperms"
      CFG_LUCKPERMS_DB_USERNAME: "luckperms"
      CFG_LUCKPERMS_DB_PASSWORD: "luckperms"
      CFG_BLANK_RESOURCE_PACK_URL: https://files.catbox.moe/ouqh1j.zip
      CFG_BLANK_RESOURCE_PACK_SHA1SUM: 118afffc54cdcd308702f81ba24e03223f15fe5f
      CFG_POLYMER_RESOURCE_PACK_URL: http://localhost:8080/polymer.zip
      CFG_POLYMER_RESOURCE_PACK_SHA1SUM: 16d069308aa917a17a6107c9bec61f1aab610632
      CFG_TRANSLATIONS_RESOURCE_PACK_URL: https://github.com/DecentM/minecraft-servers/releases/download/translations-12f6b654e3cec795d46496d8aa3bc90755a19a6e/translations.zip
      CFG_TRANSLATIONS_RESOURCE_PACK_SHA1SUM: a94df837a31ecdf2c1ba0bc790f1b0beb37768b4
    ports:
      - 25565:25565
    links:
      - luckperms-db
      - spectrum
      - fallback
    volumes:
      - ./proxy/dev-proxy-secret:/proxy-secret:ro
      - ./proxy/server:/server
      - self-host-rps:/self-host-rps

  fallback:
    build:
      context: fallback
    tty: true
    stdin_open: true
    environment:
      UID: "0"
      GID: "0"
      MEMORY: "4G"
      EULA: "TRUE"
      DIFFICULTY: "peaceful"
      SNOOPER_ENABLED: "false"
      SPAWN_PROTECTION: "256"
      VIEW_DISTANCE: "16"
      MODE: "adventure"
      SERVER_PORT: "25567"
      LEVEL_TYPE: "flat"
      CFG_PROXY_SECRET: "secret"
      CFG_LUCKPERMS_DB_HOST: "luckperms-db"
      CFG_LUCKPERMS_DB_PORT: "5432"
      CFG_LUCKPERMS_DB_NAME: "luckperms"
      CFG_LUCKPERMS_DB_USERNAME: "luckperms"
      CFG_LUCKPERMS_DB_PASSWORD: "luckperms"
    links:
      - luckperms-db

  luckperms-db:
    image: postgres:17.4

    volumes:
      - luckperms-db:/var/lib/postgresql/data

    environment:
      POSTGRES_USER: luckperms
      POSTGRES_PASSWORD: luckperms
      POSTGRES_DB: luckperms

  nginx-rp:
    image: nginx:1.27.5-alpine
    volumes:
      - self-host-rps:/usr/share/nginx/html:ro
    ports:
      - 8080:80

volumes:
  luckperms-db:
  self-host-rps:
